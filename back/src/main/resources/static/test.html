<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>FeelScore API Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        input,
        textarea,
        select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>FeelScore API Tester</h1>

        <!-- 1. 로그인 -->
        <div class="card">
            <h2>1. 로그인 (Login)</h2>
            <input type="text" id="email" placeholder="Email (예: commenter@test.com)" value="commenter@test.com">
            <input type="password" id="password" placeholder="Password" value="1234">
            <button onclick="login()">로그인</button>
            <div id="loginResult"></div>
        </div>

        <!-- 2. 게시글 작성 -->
        <div class="card">
            <h2>2. 게시글 작성 (Create Post)</h2>
            <textarea id="postContent" placeholder="게시글 내용">웹에서 작성한 테스트 게시글입니다.</textarea>
            <select id="postEmotion">
                <option value="JOY">JOY (기쁨)</option>
                <option value="SADNESS">SADNESS (슬픔)</option>
                <option value="ANGER">ANGER (분노)</option>
            </select>
            <button onclick="createPost()">게시글 작성</button>
            <div id="postResult"></div>
        </div>

        <!-- 3. 댓글 작성 -->
        <div class="card">
            <h2>3. 댓글 작성 (Create Comment)</h2>
            <input type="number" id="targetPostId" placeholder="댓글 달 게시글 ID (Post ID)" value="1">
            <textarea id="commentContent" placeholder="댓글 내용">알림 테스트용 댓글입니다!</textarea>
            <select id="commentEmotion">
                <option value="JOY">JOY (기쁨)</option>
                <option value="SADNESS">SADNESS (슬픔)</option>
            </select>
            <button onclick="submitComment()">댓글 작성</button>
            <div id="commentResult"></div>
        </div>

        <!-- 4. DM 보내기 (New!) -->
        <div class="card">
            <h2>4. DM 보내기 (Send DM)</h2>
            <input type="number" id="dmReceiverId" placeholder="받는 사람 ID (예: 1)" value="1">
            <textarea id="dmContent" placeholder="DM 내용">안녕하세요! DM 알림 테스트입니다.</textarea>
            <button onclick="sendDm()">DM 전송</button>
            <div id="dmResult"></div>
        </div>
    </div>

    <script>
        let accessToken = null;
        let userId = null;
        const BASE_URL = 'http://localhost:8080/api';

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    userId = data.id;
                    document.getElementById('loginResult').innerHTML =
                        `<pre style="color:green">로그인 성공!\nToken: ${accessToken.substring(0, 20)}...\nUser ID: ${userId}</pre>`;
                } else {
                    throw new Error(data.error_description || 'Login failed');
                }
            } catch (e) {
                document.getElementById('loginResult').innerHTML = `<pre style="color:red">${e.message}</pre>`;
            }
        }

        async function createPost() {
            if (!accessToken) return alert('먼저 로그인해주세요!');

            const content = document.getElementById('postContent').value;
            const emotion = document.getElementById('postEmotion').value; // 현재 API엔 emotion 필드가 없지만 일단 둠

            try {
                // 카테고리 ID 1번(사회) 고정
                const response = await fetch(`${BASE_URL}/v1/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        content: content,
                        categoryId: 1
                    })
                });
                const data = await response.json();
                document.getElementById('postResult').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                document.getElementById('postResult').innerHTML = `<pre style="color:red">${e.message}</pre>`;
            }
        }

        async function submitComment() {
            console.log('submitComment() called');

            if (!accessToken) {
                alert('먼저 로그인해주세요!');
                return;
            }
            if (!userId) {
                alert('로그인은 되었으나 User ID가 없습니다. 다시 로그인해주세요.');
                return;
            }

            const postId = document.getElementById('targetPostId').value;
            const content = document.getElementById('commentContent').value;
            const emotion = document.getElementById('commentEmotion').value;

            console.log(`Sending comment: Post=${postId}, User=${userId}, Content=${content}`);
            document.getElementById('commentResult').innerHTML = 'Sending...';

            try {
                const response = await fetch(`${BASE_URL}/comments?userId=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        postId: postId,
                        content: content,
                        emotion: emotion
                    })
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('commentResult').innerHTML = `<pre style="color:green">댓글 작성 성공! ID: ${data.commentId}</pre>`;
                } else {
                    const text = await response.text();
                    console.log('Error response:', text);
                    try {
                        const json = JSON.parse(text);
                        document.getElementById('commentResult').innerHTML = `<pre style="color:red">${JSON.stringify(json, null, 2)}</pre>`;
                    } catch (e) {
                        document.getElementById('commentResult').innerHTML = `<pre style="color:red">${text}</pre>`;
                    }
                }
            } catch (e) {
                console.error(e);
                document.getElementById('commentResult').innerHTML = `<pre style="color:red">JS Error: ${e.message}</pre>`;
            }
        }

        async function sendDm() {
            console.log('sendDm() called');

            if (!accessToken) {
                alert('먼저 로그인해주세요!');
                return;
            }

            const receiverId = document.getElementById('dmReceiverId').value;
            const content = document.getElementById('dmContent').value;

            console.log(`Sending DM: Receiver=${receiverId}, Content=${content}`);
            document.getElementById('dmResult').innerHTML = 'Sending...';

            try {
                const response = await fetch(`${BASE_URL}/dm/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        receiverId: receiverId,
                        content: content
                    })
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dmResult').innerHTML = `<pre style="color:green">DM 전송 성공! Message ID: ${data.messageId}</pre>`;
                } else {
                    const text = await response.text();
                    console.log('Error response:', text);
                    document.getElementById('dmResult').innerHTML = `<pre style="color:red">${text}</pre>`;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('dmResult').innerHTML = `<pre style="color:red">JS Error: ${e.message}</pre>`;
            }
        }
    </script>
</body>

</html>